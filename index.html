<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>廣島四天三夜行程｜自動生成最穩定地圖連結</title>
  <meta name="description" content="載入時自動以 Places API 取得最新 place_id，生成含 query_place_id 的 Google Maps 連結，確保一鍵開啟正確卡片。" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#fbfbfd; }
    .container { max-width: 900px; }
    .poi a { text-decoration: none; }
    .poi a:hover { text-decoration: underline; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; white-space:pre-wrap; }
    .badge-note { font-size:.85rem; }
  </style>
</head>
<body>
  <nav class="navbar bg-light sticky-top border-bottom">
    <div class="container d-flex justify-content-between align-items-center">
      <a class="navbar-brand" href="#">廣島四天三夜行程</a>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-primary" href="#day1">Day 1</a>
        <a class="btn btn-sm btn-outline-primary" href="#day2">Day 2</a>
        <a class="btn btn-sm btn-outline-primary" href="#day3">Day 3</a>
        <a class="btn btn-sm btn-outline-primary" href="#day4">Day 4</a>
      </div>
    </div>
  </nav>

  <header class="py-4">
    <div class="container">
      <h1 class="h3 mb-2">廣島四天三夜行程（自動 Place ID 連結）</h1>
      <p class="mb-1">頁面載入時以 Places API 查詢各景點 place_id，並生成含 query_place_id 的 Maps 連結，避免同名誤判與短連結失效。</p>
      <span class="badge text-bg-secondary badge-note me-2">行動優先</span>
      <span class="badge text-bg-secondary badge-note me-2">Maps URLs 規範</span>
      <span class="badge text-bg-secondary badge-note">Place ID 穩定定位</span>
    </div>
  </header>

  <main class="container pb-5">

    <!-- Day 1 -->
    <section id="day1" class="mb-4">
      <div class="card">
        <div class="card-body">
          <h2 class="h4">Day 1 市區探索（広島市内）</h2>
          <ul class="mt-3 list-unstyled poi">
            <li class="mb-3">
              麗ちゃんお好み焼き（中文：麗ちゃん廣島燒｜日文：麗ちゃん）｜
              <a href="https://www.o-reichan.jp/sp/shop.htm" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-reichan" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              廣島城（Hiroshima Castle｜日文：広島城）｜
              <a href="https://hiroshimacastle.jp" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-hiroshima-castle" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              廣島和平紀念資料館（Hiroshima Peace Memorial Museum｜日文：広島平和記念資料館）｜
              <a href="https://hpmm-db.jp/en/" target="_blank" rel="noopener">資訊頁</a> ｜ 
              <a id="map-peace-museum" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              お好み村（中文：御好村｜日文：お好み村）｜
              <a href="http://www.okonomimura.jp/" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-okonomimura" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Day 2 -->
    <section id="day2" class="mb-4">
      <div class="card">
        <div class="card-body">
          <h2 class="h4">Day 2 宮島【市外日歸】（宮島・厳島神社）</h2>
          <ul class="mt-3 list-unstyled poi">
            <li class="mb-3">
              嚴島神社（中文：嚴島神社｜日文：厳島神社）｜
              <a href="https://www.itsukushimajinja.jp" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-itsukushima-jinja" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              あなご飯 うえの（中文：穴子飯 上野｜日文：あなごめし うえの｜宮島口）｜
              <a id="map-anagomeshi-ueno" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              かき小屋（宮島口周邊）｜
              <a id="map-kakigoya" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              牡蠣屋（中文：牡蠣屋｜日文：牡蠣屋｜宮島）｜
              <a href="https://kaki-ya.jp" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-kakiya" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Day 3 -->
    <section id="day3" class="mb-4">
      <div class="card">
        <div class="card-body">
          <h2 class="h4">Day 3 呉【市外日歸】（呉市海事博物館・大和ミュージアム）</h2>
          <ul class="mt-3 list-unstyled poi">
            <li class="mb-3">
              呉市海事博物館（Yamato Museum｜中文：大和博物館｜日文：大和ミュージアム）｜
              <a href="https://yamato-museum.com" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-yamato-museum" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              入船山公園（Irifuneyama Park）｜
              <a id="map-irifuneyama" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Day 4 -->
    <section id="day4" class="mb-4">
      <div class="card">
        <div class="card-body">
          <h2 class="h4">Day 4 市區購物與庭園（広島市内）</h2>
          <ul class="mt-3 list-unstyled poi">
            <li class="mb-3">
              ビックカメラ広島駅前店（中文：BicCamera 廣島站前店）｜
              <a href="https://www.biccamera.com/bc/i/shop/shoplist/shop119.jsp" target="_blank" rel="noopener">門市頁</a> ｜ 
              <a id="map-biccamera-hiroshima" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              エディオン広島本店（中文：Edion 廣島本店）｜
              <a href="https://hiroshima.edion.com/en/" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-edion-hiroshima" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
            <li class="mb-3">
              縮景園（Shukkeien Garden｜日文：縮景園）｜
              <a href="https://shukkeien.jp" target="_blank" rel="noopener">官網</a> ｜ 
              <a id="map-shukkeien" href="#" target="_blank" rel="noopener">地圖</a>
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- 日誌 -->
    <section class="mb-4">
      <div class="card">
        <div class="card-body">
          <h2 class="h5">連結生成狀態</h2>
          <div id="log" class="log text-muted"></div>
        </div>
      </div>
    </section>

  </main>

  <script>
    // 將下列 API 金鑰替換為自己的（建議使用 HTTP 參照網址限制）
    const PLACES_API_KEY = "YOUR_API_KEY"; // TODO: replace

    // 景點與店家清單（查詢字串將用於 Text Search）
    const PLACES = [
      { id: "map-reichan", query: "麗ちゃん ekie" },
      { id: "map-hiroshima-castle", query: "Hiroshima Castle" },
      { id: "map-peace-museum", query: "Hiroshima Peace Memorial Museum" },
      { id: "map-okonomimura", query: "お好み村 Hiroshima" },
      { id: "map-itsukushima-jinja", query: "厳島神社" },
      { id: "map-anagomeshi-ueno", query: "あなごめし うえの 宮島口" },
      { id: "map-kakigoya", query: "かき小屋 宮島" },
      { id: "map-kakiya", query: "牡蠣屋 宮島" },
      { id: "map-yamato-museum", query: "Yamato Museum Kure" },
      { id: "map-irifuneyama", query: "Irifuneyama Park Kure" },
      { id: "map-biccamera-hiroshima", query: "ビックカメラ 広島駅前店" },
      { id: "map-edion-hiroshima", query: "エディオン 広島本店" },
      { id: "map-shukkeien", query: "Shukkeien Garden" },
    ];

    const TEXT_SEARCH_URL = "https://places.googleapis.com/v1/places:searchText";
    const FIELD_MASK = "places.id,places.displayName,places.formattedAddress";

    const HIROSHIMA_CENTER = { latitude: 34.395, longitude: 132.459 }; // 廣島市中心近似
    const BIAS_RADIUS = 50000; // 50km 位置偏置

    const logEl = document.getElementById("log");
    function log(line) { logEl.textContent += line + "\n"; }

    function buildMapsUrl(query, placeId) {
      const q = encodeURIComponent(query);
      if (placeId) {
        return `https://www.google.com/maps/search/?api=1&query=${q}&query_place_id=${placeId}`;
      }
      return `https://www.google.com/maps/search/?api=1&query=${q}`;
    }

    async function fetchPlaceId(textQuery) {
      const resp = await fetch(TEXT_SEARCH_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Goog-Api-Key": PLACES_API_KEY,
          "X-Goog-FieldMask": FIELD_MASK
        },
        body: JSON.stringify({
          textQuery,
          languageCode: "ja",
          regionCode: "JP",
          locationBias: { circle: { center: HIROSHIMA_CENTER, radius: BIAS_RADIUS } }
        })
      });
      if (!resp.ok) throw new Error(`Places API ${resp.status}`);
      const data = await resp.json();
      return data?.places?.[0]?.id || null; // v1: places[].id 即 place_id
    }

    async function updateLinks() {
      for (const p of PLACES) {
        try {
          const placeId = await fetchPlaceId(p.query);
          const url = buildMapsUrl(p.query, placeId);
          const a = document.getElementById(p.id);
          if (a) {
            a.href = url;
            a.textContent = "地圖";
            log(`✓ ${p.query} → ${placeId || "no-id"} (${url})`);
          } else {
            log(`! anchor not found: ${p.id}`);
          }
          // 輕量節流，避免瞬間多請求
          await new Promise(r => setTimeout(r, 120));
        } catch (e) {
          const fallback = buildMapsUrl(p.query);
          const a = document.getElementById(p.id);
          if (a) {
            a.href = fallback;
            a.textContent = "地圖";
          }
          log(`× ${p.query} error: ${e.message} (fallback URL applied)`);
        }
      }
      log("完成：已更新所有地圖連結。");
    }

    document.addEventListener("DOMContentLoaded", updateLinks);
  </script>
</body>
</html>
